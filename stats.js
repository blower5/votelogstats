"use strict";

var defaultlog = 
`
·°o_O Votes by Entry 0_o°·

==| blower5 - look, look at the sky.mp3
5.000 - Jakerson x3.86 INF
4.000 - Dunehawk x2.76 INF
6.000 - zipdisq x4.08 INF
3.000 - BubblegumOctopus x2.65 INF
6.000 - damifortune x3.09 INF
5.000 - Opilion x2.76 INF
7.000 - Frag x3.09 INF
7.000 - roz x3.75 INF
6.000 - cabbage drop x4.19 INF
6.000 - Philly Deck x2.54 INF
6.000 - B-Doh x2.1 INF

==| BubblegumOctopus - Delightful and Pleasant.mp3
6.000 - Dunehawk x2.76 INF
5.000 - zipdisq x4.08 INF
6.000 - Jakerson x3.86 INF
6.000 - damifortune x3.09 INF
5.000 - blower5 x2.1 INF
5.000 - Opilion x2.76 INF
7.000 - Frag x3.09 INF
5.000 - roz x3.75 INF
7.000 - cabbage drop x4.19 INF
6.000 - B-Doh x2.1 INF
6.000 - Philly Deck x2.54 INF

==| Dunehawk - Hidden Memories.mp3
4.000 - zipdisq x4.08 INF
4.000 - BubblegumOctopus x2.65 INF
4.000 - Jakerson x3.86 INF
4.000 - damifortune x3.09 INF
3.000 - blower5 x2.1 INF
5.000 - Opilion x2.76 INF
5.000 - Frag x3.09 INF
4.000 - roz x3.75 INF
7.000 - cabbage drop x4.19 INF
3.000 - B-Doh x2.1 INF
4.000 - Philly Deck x2.54 INF

==| Philly Deck - House Party.mp3
6.000 - zipdisq x4.08 INF
3.000 - BubblegumOctopus x2.65 INF
5.000 - Jakerson x3.86 INF
3.000 - Dunehawk x2.76 INF
5.000 - damifortune x3.09 INF
5.000 - blower5 x2.1 INF
5.000 - Opilion x2.76 INF
6.000 - Frag x3.09 INF
4.000 - roz x3.75 INF
6.000 - cabbage drop x4.19 INF
7.000 - B-Doh x2.1 INF

==| Opilion - hooo.mp3
3.000 - zipdisq x4.08 INF
3.000 - Jakerson x3.86 INF
2.000 - Dunehawk x2.76 INF
5.000 - BubblegumOctopus x2.65 INF
4.000 - damifortune x3.09 INF
3.000 - blower5 x2.1 INF
4.000 - Frag x3.09 INF
3.000 - roz x3.75 INF
4.000 - cabbage drop x4.19 INF
1.000 - B-Doh x2.1 INF
1.000 - Philly Deck x2.54 INF

==| sean - foreboding portal.mp3
4.000 - zipdisq x4.08 INF
5.000 - Jakerson x3.86 INF
4.000 - Dunehawk x2.76 INF
6.000 - BubblegumOctopus x2.65 INF
6.000 - damifortune x3.09 INF
6.000 - blower5 x2.1 INF
6.000 - Opilion x2.76 INF
6.000 - Frag x3.09 INF
6.000 - roz x3.75 INF
6.000 - cabbage drop x4.19 INF
2.000 - B-Doh x2.1 INF
2.000 - Philly Deck x2.54 INF

==| Jakerson - wooow.mp3
7.000 - zipdisq x4.08 INF
5.000 - Dunehawk x2.76 INF
7.000 - BubblegumOctopus x2.65 INF
5.000 - damifortune x3.09 INF
6.000 - blower5 x2.1 INF
7.000 - Opilion x2.76 INF
6.000 - Frag x3.09 INF
5.000 - roz x3.75 INF
6.000 - cabbage drop x4.19 INF
6.000 - B-Doh x2.1 INF
7.000 - Philly Deck x2.54 INF

==| B-Doh - HAUNTED MANSION.mp3
6.000 - zipdisq x4.08 INF
6.000 - Jakerson x3.86 INF
4.000 - Dunehawk x2.76 INF
6.000 - BubblegumOctopus x2.65 INF
5.000 - damifortune x3.09 INF
4.000 - blower5 x2.1 INF
6.000 - Frag x3.09 INF
6.000 - roz x3.75 INF
5.000 - cabbage drop x4.19 INF
5.000 - Philly Deck x2.54 INF
6.000 - Opilion x2.76 INF

==| zipdisq - tiny.mp3
4.000 - BubblegumOctopus x2.65 INF
4.000 - Dunehawk x2.76 INF
4.000 - Jakerson x3.86 INF
6.000 - damifortune x3.09 INF
4.000 - blower5 x2.1 INF
6.000 - Frag x3.09 INF
6.000 - roz x3.75 INF
5.000 - cabbage drop x4.19 INF
3.000 - B-Doh x2.1 INF
3.000 - Philly Deck x2.54 INF
4.000 - Opilion x2.76 INF

==| cabbage drop - meow machine.mp3
5.000 - zipdisq x4.08 INF
3.000 - BubblegumOctopus x2.65 INF
3.000 - Dunehawk x2.76 INF
5.000 - Jakerson x3.86 INF
5.000 - damifortune x3.09 INF
5.000 - blower5 x2.1 INF
5.000 - Frag x3.09 INF
5.000 - roz x3.75 INF
3.000 - B-Doh x2.1 INF
4.000 - Philly Deck x2.54 INF
4.000 - Opilion x2.76 INF

==| Frag - dwarven village.mp3
7.000 - zipdisq x4.08 INF
6.000 - BubblegumOctopus x2.65 INF
5.000 - Dunehawk x2.76 INF
7.000 - Jakerson x3.86 INF
7.000 - damifortune x3.09 INF
5.000 - blower5 x2.1 INF
7.000 - roz x3.75 INF
7.000 - cabbage drop x4.19 INF
4.000 - Philly Deck x2.54 INF
4.000 - Opilion x2.76 INF
6.000 - B-Doh x2.1 INF




,| tally compiled 2023-08-05 14:25:25 `;

// function go() {
//     parseData();
// }
function parseAndGraph(votelog) {
    clearRows();

    var entriesarrayunclean, entriesarrayclean;
    [entriesarrayunclean, entriesarrayclean] = parseData(votelog);

    addHeaderRow();
    for (let i in entriesarrayclean) {
        addStatRow(entriesarrayunclean[i],entriesarrayclean[i]);
    }
}

function parseData(votelog) {
    var inputByEntriesOnly = votelog.substring(votelog.search(/·°o_O Votes by Entry 0_o°·/) + 31, votelog.search(/\,\x7c tally compiled/));
    var entriesarray = inputByEntriesOnly.split("==|");
    for (let i in entriesarray) {
        entriesarray[i] = entriesarray[i].split("\n");
        //remove blank lines
        var temparraylength = entriesarray[i].length;
        for (let j in entriesarray[i]) {
            if (entriesarray[i][temparraylength-j] == "") entriesarray[i].splice(temparraylength-j,1);
        }
    }
    
    //isolate the votes TODO: voter influence is discarded
    var entriesarraynumbersonly = structuredClone(entriesarray);
    for (let i in entriesarraynumbersonly) {
        //remove top entry, which is not a vote
        entriesarraynumbersonly[i].splice(0,1);
        for (let j in entriesarraynumbersonly[i]) {
            entriesarraynumbersonly[i][j] = entriesarraynumbersonly[i][j].slice(0,5);
        }
    }
    return [entriesarray,entriesarraynumbersonly];
}

function addHeaderRow() {
    var tr = document.createElement('tr');
    
    function createth(content,className) {
        let th = document.createElement('th')
        th.textContent = content;
        return th;
    }
    tr.appendChild(createth("Entry"));
    tr.appendChild(createth("x̄"));
    tr.appendChild(createth("σ"));
    document.getElementById('entrytable').appendChild(tr);
}

function addStatRow(arrayunclean,arrayclean) {
    //calculate stats
    var mean   =   smathmean(arrayclean).toFixed(3);
    var stdevp = smathstdevp(arrayclean).toFixed(3);
    //manage graphics

    //add elements
    function createtd(content,className) {
        let td = document.createElement('td')
        td.textContent = content;
        td.className = className; 
        return td;
    }

    var tr = document.createElement('tr');
    
    tr.appendChild( createtd(arrayunclean[0], "tdname"  ) );
    tr.appendChild( createtd(mean           , "tdmean"  ) );
    tr.appendChild( createtd(stdevp         , "tdstdevp") );

    document.getElementById('entrytable').appendChild(tr);
}

function clearRows() {
    document.getElementById('entrytable').innerHTML = "";
}